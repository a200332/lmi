  # Work with proprietary repository (prerequisite: 'develop0')
  #
  # Discussed in detail here:
  #   http://lists.nongnu.org/archive/html/lmi/2016-03/msg00031.html

  # First of all, to avoid agony, do the following for msw (cygwin)
  # only, for the reasons given here:
  #   https://lists.nongnu.org/archive/html/lmi/2017-11/msg00018.html

git config --global core.filemode false

  # Initial setup: create a working copy, cloned from the
  # already-provided "blessed" repo...

cd /opt/lmi
git clone file:///opt/lmi/blessed/proprietary

  # ...then symlink its hooks/ directory:

cd /opt/lmi/proprietary
mv .git/hooks .git/hooks-orig
ln --symbolic --force --no-dereference ../hooks .git

  # When migrating to a new machine, restore that symlink explicitly
  # in case the working copy was transferred by simplistic means:

cd /opt/lmi/proprietary
ln --symbolic --force --no-dereference ../hooks .git

  # To verify proper setup at any time:

cd /opt/lmi/proprietary
readlink -f .git/hooks

  # The output should be
  #   /opt/lmi/proprietary/hooks
  # indicating that everything is in order. If the output is
  #   /opt/lmi/.git/hooks
  # then the 'ln' command above has not executed correctly.

  # For msw (cygwin) only, this command:

git config --get-all core.filemode

  # should print the word "false".

  # Create a bundle to share by email

  # After verifying proper setup as above, make some changes, then
  # commit them in whatever batches make sense (see the section
  # "When committing fails" below if anything goes wrong)

cd /opt/lmi/proprietary
  # [commit selected files by name...]
git commit one_file another_file -m"One set of changes"
  # [...or commit all changes]
git commit --all -m"Another set of changes"

  # When everything is ready to share...

cd /opt/lmi/proprietary
git bundle create YourBundleName origin/master..HEAD --branches
  # for example (substitute your own initials)
git bundle create /opt/lmi/blessed/$(date -u +'%Y%m%dT%H%MZ')-gwc.bundle origin/master..HEAD --branches

  # Email that bundle, then push the changes to your "blessed" repository

git push

  # When you receive a bundle in email...

cd /opt/lmi/proprietary
git bundle verify /path/where/you/saved/TheirBundleName
git pull /path/where/you/saved/TheirBundleName

  # ...then synchronize your "blessed" repository with your correspondent's

git push

  # Whenever a rate table changes, regenerate the binary database

cd /opt/lmi/data
rm proprietary.dat proprietary.ndx
  # native:
/opt/lmi/bin/rate_table_tool --accept --file=proprietary --merge=/opt/lmi/proprietary/tables
  # msw cross build:
wine /opt/lmi/bin/rate_table_tool --accept --file=proprietary --merge=/opt/lmi/proprietary/tables

  # When committing fails

  # As long as git hooks are set up correctly, every commit is tested
  # for common problems, and fails if any are found. Take these steps
  # to diagnose or fix such failures.

  # (1) Permissions may have been scrambled by msw (cygwin). Lines like
  #   mode change 100644 => 100755 data/sample.database
  # on the screen indicate such problems. For msw (cygwin) only, this
  # command:

git config --get-all core.filemode

  # should print the word "false", in which case this nightmare should
  # not occur.

  # To unscramble permissions if necessary, before committing do:

cd /opt/lmi/proprietary
printf "forcing correct permissions "
  for d in src data test tables; do (\
       printf "$d..." \
    && find ./$d -maxdepth 1 -type f -not -name '*.sh' -not -name '*.sed' | xargs chmod -x \
  )done; \
printf "all permissions forced\n"

  # (2) Test concinnity. The git pre-commit hook shows these commands'
  # output, filtered; these commands show the same thing, unfiltered
  # so that the diagnostics are easier to understand.

cd /opt/lmi/proprietary/data/
cd ../data  ; make srcdir=/opt/lmi/src/lmi -f /opt/lmi/src/lmi/GNUmakefile check_concinnity 2>&1 |less -S
cd ../src   ; make srcdir=/opt/lmi/src/lmi -f /opt/lmi/src/lmi/GNUmakefile check_concinnity 2>&1 |less -S
cd ../test  ; make srcdir=/opt/lmi/src/lmi -f /opt/lmi/src/lmi/GNUmakefile check_concinnity 2>&1 |less -S
cd ../tables; make srcdir=/opt/lmi/src/lmi -f /opt/lmi/src/lmi/GNUmakefile check_concinnity 2>&1 |less -S

